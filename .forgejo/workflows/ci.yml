on: [push]
jobs:
  quality:
    name: code-quality
    runs-on: docker
    steps:
      - name: checkout
        uses: https://code.forgejo.org/actions/checkout@v4
      - name: setup uv
        uses: https://github.com/astral-sh/setup-uv@v6
        with:
          enable-cache: true
          prune-cache: false
      - name: run ShellCheck
        run: make check-scripts
      - name: run pre-commit checks
        run: SKIP="shellcheck,no-commit-to-branch" make check-precommit
  build:
    name: build
    needs: quality
    runs-on: docker
    steps:
      - name: checkout
        uses: https://code.forgejo.org/actions/checkout@v4
      - name: setup uv
        uses: https://github.com/astral-sh/setup-uv@v6
        with:
          enable-cache: true
          prune-cache: false
      - name: build
        run: make publish
      - name: upload-artifacts
        uses: https://code.forgejo.org/forgejo/upload-artifact@v4
        with:
          name: web-content-${{ github.sha }}
          path: |
            output/
            !**/.gitkeep
          if-no-files-found: error
  deploy:
    name: deploy
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: docker
    steps:
      - name: download-artifacts
        uses: https://code.forgejo.org/forgejo/download-artifact@v4
        with:
          name: web-content-${{ github.sha }}
          path: output
      - name: investigate output
        run: ls -lash output
      - name: deploy
        run: |
          (umask 077 && mkdir .ssh)
          (umask 177 && touch .ssh/id_ed25519)
          echo "${{ secrets.DEPLOY_KEY }}" > .ssh/id_ed25519
          rsync -rvz --delete -e "ssh -i .ssh/id_ed25519" output/ \
          ${{secrets.DEPLOY_USER}}@${{secrets.DEPLOY_HOST}}:${{secrets.DEPLOY_TARGET_DIR}}
